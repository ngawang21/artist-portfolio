---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { useTranslations } from '../../i18n/utils';

const t = useTranslations('en');
const { slug } = Astro.params;

// Get the specific artwork
const artworksEntries = await getCollection('artworks');
const artworkEntry = artworksEntries.find(entry => entry.id === slug);

if (!artworkEntry) {
  return Astro.redirect('/gallery');
}

const artwork = {
  id: artworkEntry.id,
  slug: artworkEntry.id,
  title: artworkEntry.data.title_en,
  description: artworkEntry.data.description_en,
  image: artworkEntry.data.image,
  dimensions: artworkEntry.data.dimensions,
  price: artworkEntry.data.price,
  year: artworkEntry.data.year,
  medium: artworkEntry.data.medium,
  sold: artworkEntry.data.sold,
};

// Redirect if already sold
if (artwork.sold) {
  return Astro.redirect('/gallery');
}
---

<BaseLayout title={`Checkout - ${artwork.title}`}>
  <section class="py-20 min-h-screen bg-gray-50">
    <div class="container mx-auto px-4 max-w-6xl">
      <h1 class="font-serif text-4xl md:text-5xl font-bold text-center mb-12">
        {t('checkout.title')}
      </h1>
      
      <div class="grid md:grid-cols-2 gap-8">
        <!-- Artwork Details -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <h2 class="font-serif text-2xl font-semibold mb-6">
            {t('checkout.artworkDetails')}
          </h2>
          
          <div class="mb-6">
            <img 
              src={artwork.image} 
              alt={artwork.title}
              class="w-full h-64 object-cover rounded-lg"
            />
          </div>
          
          <div class="space-y-3">
            <h3 class="font-serif text-xl font-semibold">{artwork.title}</h3>
            <p class="text-gray-600">{artwork.description}</p>
            
            <div class="pt-4 border-t border-gray-200 space-y-2 text-sm">
              <p><strong>{t('gallery.dimensions')}:</strong> {artwork.dimensions}</p>
              <p><strong>Medium:</strong> {artwork.medium}</p>
              <p><strong>Year:</strong> {artwork.year}</p>
            </div>
            
            <div class="pt-4 border-t border-gray-200">
              <div class="flex justify-between items-center">
                <span class="text-lg font-semibold">{t('checkout.total')}:</span>
                <span class="text-3xl font-bold text-primary">â‚¬{artwork.price.toLocaleString()}</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Customer Information Form -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <h2 class="font-serif text-2xl font-semibold mb-6">
            {t('checkout.customerInfo')}
          </h2>
          
          <form id="checkout-form" class="space-y-4">
            <input type="hidden" name="artworkId" value={artwork.slug} />
            <input type="hidden" name="language" value="en" />
            
            <div>
              <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
                {t('checkout.name')} <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="name"
                name="name"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-transparent"
                placeholder="John Doe"
              />
            </div>
            
            <div>
              <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                {t('checkout.email')} <span class="text-red-500">*</span>
              </label>
              <input
                type="email"
                id="email"
                name="email"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-transparent"
                placeholder="john@example.com"
              />
            </div>
            
            <div>
              <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">
                {t('checkout.phone')} <span class="text-red-500">*</span>
              </label>
              <input
                type="tel"
                id="phone"
                name="phone"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-transparent"
                placeholder="+33 6 12 34 56 78"
              />
            </div>
            
            <div>
              <label for="address" class="block text-sm font-medium text-gray-700 mb-2">
                {t('checkout.address')}
              </label>
              <textarea
                id="address"
                name="address"
                rows="3"
                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-transparent"
                placeholder="123 Main Street, Paris, France"
              ></textarea>
            </div>
            
            <div class="pt-6">
              <button
                type="submit"
                id="submit-button"
                class="w-full bg-primary text-white px-6 py-3 rounded-md hover:bg-primary/90 transition-colors font-semibold text-lg disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {t('checkout.proceedToPayment')}
              </button>
            </div>
            
            <div id="error-message" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md text-sm">
            </div>
            
            <div id="loading-message" class="hidden bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded-md text-sm">
              Processing your request...
            </div>
          </form>
        </div>
      </div>
    </div>
  </section>
  
  <script>
    const form = document.getElementById('checkout-form') as HTMLFormElement;
    const submitButton = document.getElementById('submit-button') as HTMLButtonElement;
    const errorMessage = document.getElementById('error-message') as HTMLDivElement;
    const loadingMessage = document.getElementById('loading-message') as HTMLDivElement;
    
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Disable submit button
      submitButton.disabled = true;
      errorMessage.classList.add('hidden');
      loadingMessage.classList.remove('hidden');
      
      try {
        const formData = new FormData(form);
        const data = {
          artworkId: formData.get('artworkId'),
          name: formData.get('name'),
          email: formData.get('email'),
          phone: formData.get('phone'),
          address: formData.get('address'),
          language: formData.get('language'),
          price: {artwork.price},
          title: '{artwork.title}',
        };
        
        const response = await fetch('/.netlify/functions/create-payment', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        });
        
        if (!response.ok) {
          throw new Error('Failed to create payment');
        }
        
        const result = await response.json();
        
        // Redirect to Mollie checkout
        if (result.checkoutUrl) {
          window.location.href = result.checkoutUrl;
        } else {
          throw new Error('No checkout URL received');
        }
      } catch (error) {
        console.error('Checkout error:', error);
        errorMessage.textContent = 'An error occurred. Please try again.';
        errorMessage.classList.remove('hidden');
        loadingMessage.classList.add('hidden');
        submitButton.disabled = false;
      }
    });
  </script>
</BaseLayout>
